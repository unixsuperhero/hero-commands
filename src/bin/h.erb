#!/usr/bin/env ruby

require 'awesome_print'
require 'pry'
require 'yaml'
require 'shell'

<%= inject_files 'src/lib/hash_ext.rb.erb', 'src/lib/config.rb.erb',
  'src/lib/subcommandable.rb.erb', 'src/lib/path_env.rb.erb',
  'src/lib/project_helper.rb.erb', 'src/lib/list_filter.rb.erb',
  'src/lib/hero_helper.rb.erb' %>

class MainCommand
  include ShellCommandable

  def self.run(args=argv)
    if args.first && args.first[0] == ?@
      @project_context = ProjectHelper.project_for(args.first)
      args.shift
    end

    if project_context?
      HeroHelper.run_inside_dir(project_dir){ super }
    else
      super
    end
  end

  def self.project_context?
    ! @project_context.nil?
  end

  def self.project_dir
    return unless project_context?
    project_context[:data]
  end

  def self.project_context
    @project_context
  end

  def self.editor
    ENV['EDITOR'] || 'vim'
  end

  register_subcommand(:edit) {
    files = args.flat_map{|arg| PathEnv.search(arg) }

    HeroHelper.edit_in_editor(files)
    # system(files.unshift(editor).shelljoin)
  }

  register_subcommand(:pry) {
    puts 'Entering a pry session...'
    binding.pry
    puts 'done'
  }

  register_subcommand(:z) { # testing the exit codes for diff
    output = `diff /tmp/diff-test-a /tmp/diff-test-b &>/dev/null`
    ap output: output, sucessful: $?.success?

    output = `diff /tmp/diff-test-a /tmp/diff-test-c &>/dev/null`
    ap output: output, sucessful: $?.success?
    exit 0
  }

  register_subcommand(:run) {
    error_exit('Nothing to run...pass in cmd as arguments.') if args.empty?
    puts HeroHelper.output_from(*args)
  }

  register_subcommand(:fix) {
    unless Object.const_defined?(:FixSubcommand)
      found = PathEnv.find('new_h-fix')
      load found.first
    end

    if Object.const_defined?(:FixSubcommand)
      FixSubcommand.run(args)
      exit 0
    end

    raise Exception, 'Unable to load FixSubcommand'
  }

  # register_subcommand(:git) {
  #   GitSubcommand.run(args)
  # }


end

MainCommand.load_subcommands_by_prefix('h')
MainCommand.run



# vim: ft=ruby

class BanditSubcommand < Subcommandable
  let(:new_bandit_dir) {
    File.join(Dir.home, 'projects', 'bandit')
  }

  def self.bandit_dir
    File.join(Dir.home, 'projects', 'bandit')
  end

  def self.yaml_file
    File.join(bandit_dir, 'passwords.yml')
  end

  def self.cd_to_dir
    Dir.chdir(bandit_dir)
  end

  def self.config
    @config_file ||= Config.new(yaml_file, 'passwords')
  end

  dynamic_subcommand {
    cd_to_dir
    game = subcommand
    pw = config.data[game.to_i]
    system './bandit.exp', game, pw
    exit 0
  }

  register_subcommand(:pry) {
    cd_to_dir
    binding.pry
  }

  register_subcommand(:list, :show) {
    cd_to_dir
    ap passwords: config.data
  }

  register_subcommand(:localhost) {
    cmd = %{nextgame=$(( $(whoami | egrep -o "[0-9]+") + 1 )); ssh localhost -l "bandit${nextgame}"}
    `printf '#{cmd}' | pbcopy`
  }

  register_subcommand(:password, :pw) {
    cd_to_dir
    game,pw = args.first(2)
    config.merge(game.to_i => pw)
    # puts format('config saved: %s', config.data)
    puts format('config saved: %s', config.save)
    exit 0
  }
end

MainCommand.register_subcommand(:bandit) {
  BanditSubcommand.run(MainCommand.args)
}

